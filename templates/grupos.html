{% extends "base.html" %}

{% block title %}Grupos - Almac√©n Satelital San Luis{% endblock %}

{% block page_title %}Grupos{% endblock %}
{% block page_subtitle %}Clasificaci√≥n de repuestos y equipos{% endblock %}

{% block content %}
<!-- Encabezado con bot√≥n para nuevo grupo -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üè∑Ô∏è Gesti√≥n de Grupos</h2>
        {% if request.state.current_user and request.state.current_user.rol in ['admin', 'operador'] %}
        <button onclick="abrirModalGrupo()" class="btn btn-primary">‚ûï Nuevo Grupo</button>
        {% endif %}
    </div>
</div>

<!-- Modal para registrar nuevo grupo -->
<div id="modalGrupo" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üè∑Ô∏è Registrar Nuevo Grupo</h3>
            <span class="close" onclick="cerrarModalGrupo()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="formGrupo" method="post" onsubmit="return validarFormularioGrupo(this)">
                <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="nombre">Nombre del Grupo</label>
                        <input type="text" id="nombre" name="nombre" class="form-control" required 
                               placeholder="ej: Electr√≥nicos" maxlength="100">
                        <small style="color: #6b7280;">Nombre √∫nico para identificar el grupo</small>
                    </div>
                    <div class="form-group">
                        <label for="descripcion">Descripci√≥n (Opcional)</label>
                        <textarea id="descripcion" name="descripcion" class="form-control" 
                                  placeholder="ej: Productos electr√≥nicos y tecnol√≥gicos" maxlength="500" rows="3"></textarea>
                        <small style="color: #6b7280;">Descripci√≥n opcional del grupo</small>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="activo" name="activo" checked>
                        <span>Grupo activo (disponible para productos)</span>
                    </label>
                </div>
                <div style="margin-top: 25px; text-align: right;">
                    <button type="button" onclick="cerrarModalGrupo()" class="btn btn-secondary">‚ùå Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Guardar Grupo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="card">
    <h3>üìã Lista de Grupos</h3>
    {% if grupos %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Descripci√≥n</th>
                    <th>Estado</th>
                    <th>Fecha Creaci√≥n</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for grupo in grupos %}
                <tr class="{% if not grupo.activo %}inactive-row{% endif %}">
                    <td><strong>{{ grupo.nombre }}</strong></td>
                    <td>{{ grupo.descripcion or '-' }}</td>
                    <td>
                        {% if grupo.activo %}
                        <span class="badge badge-entrada">‚úÖ Activo</span>
                        {% else %}
                        <span class="badge badge-salida">‚ùå Inactivo</span>
                        {% endif %}
                    </td>
                    <td>{{ grupo.fecha_creacion.strftime('%d/%m/%Y') }}</td>
                    <td>
                        {% if request.state.current_user and request.state.current_user.rol in ['admin', 'operador'] %}
                        <form method="post" action="/grupos/{{ grupo.id }}/toggle" style="display: inline;">
                            {% if grupo.activo %}
                            <button type="submit" class="btn btn-secondary" style="padding: 5px 10px; font-size: 14px;"
                                    onclick="return confirm('¬øDesactivar este grupo? Los productos asociados mantendr√°n la referencia.')">
                                ‚ùå Desactivar
                            </button>
                            {% else %}
                            <button type="submit" class="btn btn-success" style="padding: 5px 10px; font-size: 14px;">
                                ‚úÖ Activar
                            </button>
                            {% endif %}
                        </form>
                        {% else %}
                        <span class="text-muted">Solo lectura</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>No hay grupos registrados a√∫n.</p>
    <div style="text-align: center; margin: 20px 0;">
        <button onclick="abrirModalGrupo()" class="btn btn-primary">‚ûï Crear Primer Grupo</button>
    </div>
    {% endif %}
</div>

<script>
// Funciones para el modal de grupos
function abrirModalGrupo() {
    document.getElementById('modalGrupo').style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    setTimeout(() => {
        document.getElementById('nombre').focus();
    }, 100);
}

function cerrarModalGrupo() {
    document.getElementById('modalGrupo').style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Limpiar formulario
    document.getElementById('formGrupo').reset();
    document.getElementById('activo').checked = true;
}

// Validaci√≥n del formulario
function validarFormularioGrupo(form) {
    let valido = true;
    const campos = form.querySelectorAll('input[required]');
    
    // Limpiar errores previos
    campos.forEach(function(campo) {
        campo.style.borderColor = '#e5e7eb';
    });
    
    // Validar campos requeridos
    campos.forEach(function(campo) {
        if (!campo.value.trim()) {
            campo.style.borderColor = '#ef4444';
            valido = false;
        }
    });
    
    // Validaci√≥n espec√≠fica del nombre
    const nombre = form.querySelector('#nombre');
    if (nombre && nombre.value) {
        if (nombre.value.length < 2) {
            nombre.style.borderColor = '#ef4444';
            alert('El nombre debe tener al menos 2 caracteres');
            valido = false;
        }
        if (nombre.value.length > 100) {
            nombre.style.borderColor = '#ef4444';
            alert('El nombre no puede exceder 100 caracteres');
            valido = false;
        }
    }
    
    // Validaci√≥n de la descripci√≥n
    const descripcion = form.querySelector('#descripcion');
    if (descripcion && descripcion.value && descripcion.value.length > 500) {
        descripcion.style.borderColor = '#ef4444';
        alert('La descripci√≥n no puede exceder 500 caracteres');
        valido = false;
    }
    
    return valido;
}

// Funcionalidad del modal
document.addEventListener('DOMContentLoaded', function() {
    // Cerrar modal con ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modalGrupo = document.getElementById('modalGrupo');
            if (modalGrupo && modalGrupo.style.display === 'block') {
                cerrarModalGrupo();
            }
        }
    });
    
    // Cerrar modal haciendo clic fuera
    const modalGrupo = document.getElementById('modalGrupo');
    if (modalGrupo) {
        modalGrupo.addEventListener('click', function(event) {
            if (event.target === this) {
                cerrarModalGrupo();
            }
        });
    }
});
</script>

<style>
.inactive-row {
    opacity: 0.6;
    background-color: #f9fafb;
}

.inactive-row td {
    color: #6b7280;
}
</style>
{% endblock %}
